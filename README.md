# TCSC (Tissue co-regulation score regression)

TCSC is a statistical genetics method to identify causal tissues in diseases and complex traits. We leverage TWAS and GWAS summary statistics while explicitly modeling the genetic co-regulation of genes across tissues.

## Using TCSC

### Dependencies

R v.3.6.1

### Quick Start: Apply TCSC to new GWAS summary statistics and default gene expression data from GTEx
1. Preprocess your GWAS summary statistics such that they are in LDSC format

See directions at https://github.com/bulik/ldsc/wiki/Summary-Statistics-File-Format
Refer to your genome-wide summary statistics using the path and name of your trait as suggested below
```
your_genomewide_sumstats=your_path/${trait}.sumstats
```

2. Clone the TCSC github repository
```
git clone https://github.com/TiffanyAmariuta/TCSC
```

3. Clone FUSION github repository

```
git clone https://github.com/gusevlab/fusion_twas
```

4. Download and unzip LD reference files for 1000 Genomes European population
```
wget https://storage.googleapis.com/broad-alkesgroup-public/LDSCORE/1000G_Phase3_plinkfiles.tgz
tar zxvf 1000G_Phase3_plinkfiles.tgz
```

5. Download and unzip TCSC gene expression weight files
```
mkdir -p TCSC_weight_files/v8_320EUR/
cd TCSC_weight_files/v8_320EUR/
for tissue in `cat TissuesA.txt`
do
wget https://storage.googleapis.com/broad-alkesgroup-public/TCSC/GeneExpressionModels/eQTL_samplesize_320/${tissue}.tar.gz
done

mkdir -p TCSC_weight_files/v8_allEUR/
cd TCSC_weight_files/v8_allEUR/
for tissue in `cat TissuesB.txt`
do
wget https://storage.googleapis.com/broad-alkesgroup-public/TCSC/GeneExpressionModels/eQTL_samplesize_all/${tissue}.tar.gz
done

cd ../v8_320EUR/
for tissue in `cat TissuesC.txt`
do
wget https://storage.googleapis.com/broad-alkesgroup-public/TCSC/GeneExpressionModels/eQTL_samplesize_320/${tissue}.post.meta.tar.gz
done
```

6. Run FUSION to perform TWAS analysis on provided gene expression data

```
#A. GTEx tissues that we downsampled to N = 320 individuals 
for tissue in `cat TissuesA.txt`
do
for chr in {1..22}
do
Rscript fusion_twas-master/FUSION.assoc_test.R --sumstats $your_genomewide_sumstats --weights TCSC/weights/320EUR_metatissues/${tissue}.pos --weights_dir TCSC_weight_files/v8_320EUR --ref_ld_chr 1000G_EUR_Phase3_plink/1000G.EUR.QC. --chr $chr --out results_320/v8_320EUR.${trait}/v8_320EUR.${trait}.${tissue}.${chr}.dat
done
done

#B. GTEx tissues with small sample size that we could not downsample
for tissue in `cat TissuesB.txt`
do
for chr in {1..22}
do
Rscript fusion_twas-master/FUSION.assoc_test.R --sumstats $your_genomewide_sumstats --weights TCSC/weights/allEUR_tissues/${tissue}.pos --weights_dir TCSC_weight_files/v8_allEUR --ref_ld_chr 1000G_EUR_Phase3_plink/1000G.EUR.QC. --chr $chr --out results_all/v8_allEUR.${trait}/v8_allEUR.${trait}.${tissue}.${chr}.dat
done
done

#C. Meta-analyzed GTEx tissues which had small sample size and high genetic correlation to another GTEx tissue 
for tissue in `cat TissuesC.txt`
do
for chr in {1..22}
do
Rscript TCSC/analysis/FUSION.assoc_test.meta.R --sumstats $your_genomewide_sumstats --weights TCSC/weights/320EUR_metatissues/${tissue}.pos --weights_dir TCSC_weight_files/v8_320EUR --ref_ld_chr 1000G_EUR_Phase3_plink/1000G.EUR.QC. --chr $chr --out results_320/v8_320EUR.${trait}/v8_320EUR.${trait}.${tissue}.${chr}.dat
done
done
```

7. Aggregate TWAS results across chromosomes

```
type=large
for tissue in `cat TissuesA.txt`
do
Rscript concat_chrs.R ${trait},${tissue},${type}
done

type=small
for tissue in `cat TissuesB.txt`
do
Rscript concat_chrs.R ${trait},${tissue},${type}
done

type=large
for tissue in `cat TissuesC.txt`
do
Rscript concat_chrs.R ${trait},${tissue},${type}
done

```

### Input Data 

1. Signed GWAS summary statistics (formatted for S-LDSC; Finucane 2015 Nat Genet)
```
sumstats/
```

2. Gene expression prediction models

In our primary analysis, for tissues with sample size greater than 320, we subsampled to 320 individuals per tissue; for groups of tissues with sample size less than 320 and highly correlation of marginal eQTL effect sizes, we meta-analyzed gene expression models such that each meta-tissue has an effective sample size of 320 individuals. These gene expression prediction models can be found here: https://alkesgroup.broadinstitute.org/TCSC/GeneExpressionModels/eQTL_samplesize_320/

Note: for prediction models using *all* GTEx v8 European samples, please see http://gusevlab.org/projects/fusion/. 

You can find a list of cis heritable genes per tissue in each of the above analyses here: 
```
weights/
```

3. TWAS summary statistics computed using FUSION (Gusev 2016 Nat Genet; http://gusevlab.org/projects/fusion/)

While we cannot provide TWAS summary statistics for all of our analyses on Github due to file quantity, we provide one representative set of TWAS summary statistics for BMI. Other TWAS summary statistics generated by our study can be found here: https://alkesgroup.broadinstitute.org/TCSC/TWAS_sumstats/
```
twas_statistics/
```

### Running TCSC

1. Using gene expression prediction models for cis-heritable genes (GCTA p < 0.01, GCTA h2 estimation > 0, cross validation R2 > 0), impute gene expression into reference panel, e.g. 489 European individuals in 1KG. 

We use FUSION (http://gusevlab.org/projects/fusion/) to first compute score files for each gene expression model. Then we use plink, as done in FUSION, to impute gene expression into 1KG individuals.
```
predicted_expression/
```

2. Construct gene and tissue co-regulation scores using squared correlations of predicted expression and applying bias correction (using gene model accuracy) when tissue t = t'. 

```
analysis/MakeCoregulationScores.R
```

3. Prepare input files for the analysis of all traits. 
```
analysis/TCSC_setup.R
```

4. Run TCSC regression for each trait. 
```
analysis/Run_TCSC.R $trait
```


